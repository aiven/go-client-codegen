// Code generated by Aiven. DO NOT EDIT.

package clickhouse

import (
	"context"
	"encoding/json"
	"fmt"
	"net/url"
)

type Handler interface {
	// ServiceClickHouseDatabaseCreate create a database
	// POST /v1/project/{project}/service/{service_name}/clickhouse/db
	// https://api.aiven.io/doc/#tag/Service:_ClickHouse/operation/ServiceClickHouseDatabaseCreate
	ServiceClickHouseDatabaseCreate(ctx context.Context, project string, serviceName string, in *ServiceClickHouseDatabaseCreateIn) error

	// ServiceClickHouseDatabaseDelete delete a database
	// DELETE /v1/project/{project}/service/{service_name}/clickhouse/db/{database}
	// https://api.aiven.io/doc/#tag/Service:_ClickHouse/operation/ServiceClickHouseDatabaseDelete
	ServiceClickHouseDatabaseDelete(ctx context.Context, project string, serviceName string, database string) error

	// ServiceClickHouseDatabaseList list all databases
	// GET /v1/project/{project}/service/{service_name}/clickhouse/db
	// https://api.aiven.io/doc/#tag/Service:_ClickHouse/operation/ServiceClickHouseDatabaseList
	ServiceClickHouseDatabaseList(ctx context.Context, project string, serviceName string) ([]DatabaseOut, error)

	// ServiceClickHouseQueryStats return statistics on recent queries
	// GET /v1/project/{project}/service/{service_name}/clickhouse/query/stats
	// https://api.aiven.io/doc/#tag/Service:_ClickHouse/operation/ServiceClickHouseQueryStats
	ServiceClickHouseQueryStats(ctx context.Context, project string, serviceName string) ([]QueryOut, error)

	// ServiceClickHouseTieredStorageSummary get the ClickHouse tiered storage summary
	// GET /v1/project/{project}/service/{service_name}/clickhouse/tiered-storage/summary
	// https://api.aiven.io/doc/#tag/Service:_ClickHouse/operation/ServiceClickHouseTieredStorageSummary
	ServiceClickHouseTieredStorageSummary(ctx context.Context, project string, serviceName string) (*ServiceClickHouseTieredStorageSummaryOut, error)
}

func NewHandler(doer doer) ClickHouseHandler {
	return ClickHouseHandler{doer}
}

type doer interface {
	Do(ctx context.Context, operationID, method, path string, v any) ([]byte, error)
}

type ClickHouseHandler struct {
	doer doer
}

func (h *ClickHouseHandler) ServiceClickHouseDatabaseCreate(ctx context.Context, project string, serviceName string, in *ServiceClickHouseDatabaseCreateIn) error {
	path := fmt.Sprintf("/v1/project/%s/service/%s/clickhouse/db", url.PathEscape(project), url.PathEscape(serviceName))
	_, err := h.doer.Do(ctx, "ServiceClickHouseDatabaseCreate", "POST", path, in)
	return err
}
func (h *ClickHouseHandler) ServiceClickHouseDatabaseDelete(ctx context.Context, project string, serviceName string, database string) error {
	path := fmt.Sprintf("/v1/project/%s/service/%s/clickhouse/db/%s", url.PathEscape(project), url.PathEscape(serviceName), url.PathEscape(database))
	_, err := h.doer.Do(ctx, "ServiceClickHouseDatabaseDelete", "DELETE", path, nil)
	return err
}
func (h *ClickHouseHandler) ServiceClickHouseDatabaseList(ctx context.Context, project string, serviceName string) ([]DatabaseOut, error) {
	path := fmt.Sprintf("/v1/project/%s/service/%s/clickhouse/db", url.PathEscape(project), url.PathEscape(serviceName))
	b, err := h.doer.Do(ctx, "ServiceClickHouseDatabaseList", "GET", path, nil)
	if err != nil {
		return nil, err
	}
	out := new(serviceClickHouseDatabaseListOut)
	err = json.Unmarshal(b, out)
	if err != nil {
		return nil, err
	}
	return out.Databases, nil
}
func (h *ClickHouseHandler) ServiceClickHouseQueryStats(ctx context.Context, project string, serviceName string) ([]QueryOut, error) {
	path := fmt.Sprintf("/v1/project/%s/service/%s/clickhouse/query/stats", url.PathEscape(project), url.PathEscape(serviceName))
	b, err := h.doer.Do(ctx, "ServiceClickHouseQueryStats", "GET", path, nil)
	if err != nil {
		return nil, err
	}
	out := new(serviceClickHouseQueryStatsOut)
	err = json.Unmarshal(b, out)
	if err != nil {
		return nil, err
	}
	return out.Queries, nil
}
func (h *ClickHouseHandler) ServiceClickHouseTieredStorageSummary(ctx context.Context, project string, serviceName string) (*ServiceClickHouseTieredStorageSummaryOut, error) {
	path := fmt.Sprintf("/v1/project/%s/service/%s/clickhouse/tiered-storage/summary", url.PathEscape(project), url.PathEscape(serviceName))
	b, err := h.doer.Do(ctx, "ServiceClickHouseTieredStorageSummary", "GET", path, nil)
	if err != nil {
		return nil, err
	}
	out := new(ServiceClickHouseTieredStorageSummaryOut)
	err = json.Unmarshal(b, out)
	if err != nil {
		return nil, err
	}
	return out, nil
}

type DatabaseOut struct {
	Engine   string            `json:"engine"`
	Name     string            `json:"name"`
	Required bool              `json:"required"`
	State    DatabaseStateType `json:"state,omitempty"`
}
type DatabaseStateType string

const (
	DatabaseStateTypeOk              DatabaseStateType = "ok"
	DatabaseStateTypePendingCreation DatabaseStateType = "pending_creation"
	DatabaseStateTypePendingRemoval  DatabaseStateType = "pending_removal"
)

func DatabaseStateTypeChoices() []string {
	return []string{"ok", "pending_creation", "pending_removal"}
}

type HourlyOut struct {
	EstimatedCost   string `json:"estimated_cost,omitempty"`
	HourStart       string `json:"hour_start"`
	PeakStoredBytes int    `json:"peak_stored_bytes"`
}
type QueryOut struct {
	Calls      *int     `json:"calls,omitempty"`
	Database   string   `json:"database,omitempty"`
	MaxTime    *int     `json:"max_time,omitempty"`
	MeanTime   *int     `json:"mean_time,omitempty"`
	MinTime    *int     `json:"min_time,omitempty"`
	P95Time    *int     `json:"p95_time,omitempty"`
	Query      string   `json:"query,omitempty"`
	Rows       *float64 `json:"rows,omitempty"`
	StddevTime *int     `json:"stddev_time,omitempty"`
	TotalTime  *int     `json:"total_time,omitempty"`
}
type ServiceClickHouseDatabaseCreateIn struct {
	Database string `json:"database"`
}
type ServiceClickHouseTieredStorageSummaryOut struct {
	CurrentCost         string                 `json:"current_cost"`
	ForecastedCost      string                 `json:"forecasted_cost"`
	ForecastedRate      string                 `json:"forecasted_rate,omitempty"`
	StorageUsageHistory StorageUsageHistoryOut `json:"storage_usage_history"`
	TotalStorageUsage   int                    `json:"total_storage_usage"`
}
type StorageUsageHistoryOut struct {
	Hourly []HourlyOut `json:"hourly"`
}
type serviceClickHouseDatabaseListOut struct {
	Databases []DatabaseOut `json:"databases"`
}
type serviceClickHouseQueryStatsOut struct {
	Queries []QueryOut `json:"queries"`
}
